<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>全文检索</title>
    <link rel="stylesheet" type="text/css" href="images/styler.css" />
    <script type="text/javascript" src="images/jquery-1.7.2.min.js"></script>
    <script type="text/javascript" src="images/index2.js"></script>
    <script type="text/javascript" src="images/jscroll.js"></script>

    <script>
        var dataurl = 'http://116.52.249.7:8081/search/search';
        var sobj = '';

        $(function () {
            sobj = {
                keyword: decodeURI(decodeURI(getParameter('keyword'))),
                siteid: decodeURI(decodeURI(getParameter('siteid'))),
                orderby: "date",
                pageNum: 15,
                range: "",
                starttime: decodeURI(decodeURI(getParameter('starttime'))),
                endtime: decodeURI(decodeURI(getParameter('endtime'))),
                stype: decodeURI(decodeURI(getParameter('stype'))),
                func: "basicSearch",
                currentPage: 1,
                dim: "",

            }
            drawTable();
        });

        function getParameter(n) {
            var l = window.location.search;
            if (l != '') {
                l = l.substring(1);
                if (l.indexOf('&') >= 0) {
                    var kvs = l.split('&');
                    for (var i = 0; i < kvs.length; i++) {
                        var kv = kvs[i];
                        if (kv.indexOf('=') >= 0) {
                            var pvs = kv.split('=');
                            if (pvs[0] == n) return pvs[1];
                        }
                    }
                } else {
                    if (l.indexOf('=') >= 0) {
                        var kvs = l.split('=');
                        if (kvs[0] == n) return kvs[1];
                    }
                }
            }
            return '';
        }

        function drawTable() {
            $.ajax({
                url: dataurl,
                data: sobj,
                dataType: "jsonp",
                jsonp: "callback",
                jsonpCallback: "callback",
                success: function (result) {
                    $('#keyw').empty().append(result.keyword);
                    $('#totalHits').empty().append(result.totalHits);
                    var docHtml = [];
                    var pageHtml = [];
                    var labelsHtml = [];
                    // if (result.totalHits < 1) {
                    // 	return;
                    // }
                    //文档列表
                    var dnum = result.list.length;
                    if (dnum < 1) {
                        $('#doclist').empty().html("");
                    } else {
                        for (var i = 0; i < dnum; i++) {
                            docHtml.push("<tr><td><a href='" + result.list[i].docPubUrl +
                                "' target='_blank'><font color='#004986'><u>" +
                                result.list[i].docTitle + "</u></font></a><br> <font color=gray>" +
                                formatDate(result.list[i].docPubTime) +
                                "</font>&nbsp;--&nbsp;" + result.list[i].docContent + "</td></tr>");
                        }
                        $('#doclist').empty().html(docHtml.join(''));
                    }
                    //栏目列表
                    var cnum = 0;
                    if (result.labels != null) {
                        cnum = result.labels.length;
                    }
                    if (cnum < 1) {
                        $('#dlabel').empty().html("");
                    } else {
                        for (var ci = 0; ci < cnum; ci++) {
                            labelsHtml.push("<a href='javascript:;' onclick='chnlSer(\"" + result.labels[ci]
                                .label + "\")'>" + result.labels[
                                    ci].label + "(" + result.labels[ci].value + ")</a> ")
                        }
                        $('#dlabel').empty().html(labelsHtml.join(''));
                    }
                    try {
                        sobj.func = result.func;
                        sobj.currentPage = parseInt(result.currentPage);
                        sobj.pageNum = parseInt(result.pageNum);
                        sobj.dim = result.dim;
                        sobj.stype = result.stype;
                    } catch (e) {}
                    //分页参数
                    //总页数
                    var pageCount = Math.ceil(result.totalHits / result.pageNum);
                    if (pageCount < 1) {
                        $('#dpage').empty().html("");
                    } else {
                        $('#dpage').empty().html('共' + pageCount + '页&nbsp;&nbsp;共' + result.totalHits +
                            '条&nbsp;&nbsp;<a href="javascript:void(0)" onclick="gotoPage(1)">首页</a>&nbsp;&nbsp;<a href="javascript:void(0)" onclick="goPrev()">上一页</a>&nbsp;&nbsp;第' +
                            result.currentPage +
                            '页&nbsp;&nbsp;<a href="javascript:void(0)" onclick="goNext(' + pageCount +
                            ')">下一页</a>&nbsp;&nbsp;<a href="javascript:gotoPage(' + pageCount +
                            ')">尾页</a>&nbsp;&nbsp;转到第<input type="text" name="inputpage" id="inputpage" style="width:35px" />页&nbsp;&nbsp;<input type="button" onclick="submitpage(' +
                            pageCount + ')" style="width:42px" value="提交" />'
                        );
                    }
                }
            });

        }

        function gotoPage(p) {
            sobj.currentPage = p;
            drawTable();
        }

        function goPrev() {
            if (sobj.currentPage > 1) {
                gotoPage(sobj.currentPage - 1);
            }
        }

        function goNext(pageCount) {
            if (sobj.currentPage < pageCount) {
                gotoPage(sobj.currentPage + 1);
            }
        }

        function docOrder(otype) {
            sobj.orderby = otype;
            drawTable();
        }

        function chnlSer(chnlName) {
            sobj.func = "drillDown";
            sobj.dim = chnlName;
            sobj.currentPage = 1;
            drawTable();
        }

        function dateFilter(flag) {
            sobj.range = flag;
            drawTable();
        }

        function submitpage(pageCount) {
            var sv = document.getElementById('inputpage').value;
            if (sv == null || sv == '') {
                alert('请输入页面！');
                return;
            } else if (isNaN(sv)) {
                alert('页码必须是数字！');
                return;
            } else if (parseInt(sv) < 1 || parseInt(sv) > pageCount) {
                alert('输入的页码不存在！');
                return;
            }
            gotoPage(parseInt(sv));
        }

        function formatDate(pubtime) {
            return pubtime.substring(0, pubtime.indexOf(" "));
        }
    </script>
</head>

<body>

    <div style="width:1000px;margin:0 auto">
        <div class="web_top">
            <div class="mian1000">
                <ul class="fl wid255 bg l_nav" style=" padding-bottom:50px">
                    <h3 class="marb10">结果排序</h3>
                    <a href="javascript:;" onclick="docOrder('score')">按相关度排序</a>
                    <a href="javascript:;" onclick="docOrder('date')">按发布时间排序</a>
                    <h3 class="marb10">时间过滤</h3>
                    <a href="javascript:;" onclick="dateFilter('all')">全部</a>
                    <a href="javascript:;" onclick="dateFilter('day')">一天内</a>
                    <a href="javascript:;" onclick="dateFilter('week')">一周内</a>
                    <a href="javascript:;" onclick="dateFilter('month')">一月内</a>
                    <a href="javascript:;" onclick="dateFilter('year')">一年内</a>
                    <h3 class="marb10">按栏目过滤</h3>
                    <div id="dlabel">
                    </div>
                </ul>
                <ul class="fr wid640" id="sstatus">
                    <p style="height:35px">检索关键词:
                        <font color="red" id="keyw"></font>，共命中
                        <font color="red" id="totalHits"></font> 条记录
                    </p>
                    <table class="gridtable" id="doclist">
                    </table>
                    <p class="pages mart20" id="dpage">
                    </p>
                </ul>
            </div>
        </div>
        <p class="clear"></p>
    </div>

</body>

</html>